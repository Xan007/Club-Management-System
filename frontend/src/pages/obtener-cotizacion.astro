---
import BaseLayout from '../layouts/BaseLayout.astro'
import millanuraImg from '../assets/millanura.jpg'
import barImg from '../assets/bar.jpg'
import empresarialImg from '../assets/empresarial.jpg'
import terrazaImg from '../assets/terraza.jpg'
import kioskoImg from '../assets/kiosko.jpg'
import presidencialImg from '../assets/presidencial.jpg'

const imageMap = {
  'MI LLANURA': millanuraImg,
  'BAR': barImg,
  'EMPRESARIAL': empresarialImg,
  'TERRAZA': terrazaImg,
  'KIOSKO': kioskoImg,
  'PRESIDENTE': presidencialImg,
}

// Datos est√°ticos para build
const espacios = [
  { id: 1, nombre: 'MI LLANURA', capacidadMaxima: 100 },
  { id: 2, nombre: 'BAR', capacidadMaxima: 60 },
  { id: 3, nombre: 'EMPRESARIAL', capacidadMaxima: 35 },
  { id: 4, nombre: 'TERRAZA', capacidadMaxima: 30 },
  { id: 5, nombre: 'KIOSKO', capacidadMaxima: 60 },
  { id: 6, nombre: 'PRESIDENTE', capacidadMaxima: 15 },
]
---

<BaseLayout title="Obtener cotizaci√≥n - Club del Meta">
  <section class="cotizacion">
    <header class="cotizacion__header">
      <h1>Solicita tu cotizaci√≥n</h1>
      <p>Selecciona el sal√≥n, completa los datos y recibe tu propuesta personalizada al instante.</p>
    </header>

    <div class="cotizacion__container">
      <aside class="cotizacion__media">
        <img id="salon-image" src={millanuraImg.src} alt="Imagen del sal√≥n seleccionado" />
        <div class="salon-info">
          <h2 id="salon-title">MI LLANURA</h2>
          <p id="salon-description">Sal√≥n insignia con vista a las √°reas verdes, ambientaci√≥n adaptable. Ideal para recepciones, matrimonios y eventos corporativos.</p>
          <ul id="salon-features">
            <li id="capacidad-info">Capacidad: hasta 100 personas</li>
            <li id="precio-4h-info">4 horas: Cargando...</li>
            <li id="precio-8h-info">8 horas: Cargando...</li>
          </ul>
        </div>
      </aside>

      <main class="cotizacion__form">
        <form id="cotizacion-form">
          <!-- Paso 1: Selecci√≥n del Sal√≥n y Configuraci√≥n -->
          <div class="form-section">
            <h3>1. Sal√≥n y Configuraci√≥n</h3>
            
            <div class="field">
              <label for="salon">Sal√≥n *</label>
              <select id="salon" name="salon" required>
                {espacios.map((espacio) => {
                  const imgSrc = imageMap[espacio.nombre]?.src || millanuraImg.src
                  return (
                    <option 
                      value={JSON.stringify({ id: espacio.id, nombre: espacio.nombre })} 
                      data-img={imgSrc}
                      data-capacidad={espacio.capacidadMaxima}
                    >
                      {espacio.nombre}
                    </option>
                  )
                })}
              </select>
            </div>

            <div class="field">
              <label for="disposicion">Disposici√≥n del Sal√≥n *</label>
              <select id="disposicion" name="disposicion" required>
                <option value="">Selecciona una disposici√≥n</option>
              </select>
            </div>
          </div>

          <!-- Paso 2: Fecha, Hora y Duraci√≥n -->
          <div class="form-section">
            <h3>2. Fecha y Hora</h3>
            
            <div class="field grid-2">
              <div>
                <label for="date">Fecha del Evento *</label>
                <input id="date" name="date" type="date" required />
                <small id="horario-info" style="display: none; margin-top: 0.5rem; padding: 0.75rem; background: #ecfdf5; border-left: 3px solid #10b981; color: #065f46; border-radius: 4px;"></small>
              </div>
              <div>
                <label for="time">Hora de Inicio *</label>
                <select id="time" name="time" required disabled>
                  <option value="">Selecciona primero fecha y sal√≥n</option>
                </select>
                <small id="horas-info" style="display: none; margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;"></small>
              </div>
            </div>

            <div class="field grid-2">
              <div>
                <label for="duration">Duraci√≥n (horas) * - M√≠nimo 4h, M√°ximo 8h</label>
                <input id="duration" name="duration" type="number" min="4" max="8" value="4" required />
                <small>Las horas adicionales a 8 se cobran por separado</small>
              </div>
              <div>
                <label>Hora Final</label>
                <input id="hora-final" type="text" readonly disabled style="background: #f3f4f6; color: #6b7280; cursor: not-allowed;" value="Selecciona hora de inicio" />
                <small id="duracion-info" style="display: none; margin-top: 0.5rem; font-size: 0.875rem; color: #10b981;"></small>
              </div>
            </div>
          </div>

          <!-- Paso 3: Tipo de Evento y Asistentes -->
          <div class="form-section">
            <h3>3. Tipo de Evento</h3>
            
            <div class="field grid-2">
              <div>
                <label for="tipoEvento">Tipo de Evento *</label>
                <select id="tipoEvento" name="tipoEvento" required>
                  <option value="">Selecciona un tipo</option>
                  <option value="social">Social (Matrimonio, Cumplea√±os, Reuni√≥n)</option>
                  <option value="empresarial">Empresarial (Conferencia, Reuni√≥n)</option>
                  <option value="capacitacion">Capacitaci√≥n / Workshop</option>
                </select>
              </div>
              <div>
                <label for="asistentes">Cantidad de Asistentes * <span id="capacidad-info-text"></span></label>
                <input id="asistentes" name="asistentes" type="number" min="1" value="50" required />
              </div>
            </div>
          </div>

          <!-- Paso 4: Servicios Adicionales -->
          <div class="form-section">
            <h3>4. Servicios Adicionales</h3>
            
            <div class="checkboxes" id="servicios-checkboxes">
              <!-- Los servicios se cargar√°n desde el backend -->
            </div>
          </div>

          <!-- Paso 5: Informaci√≥n de Contacto -->
          <div class="form-section">
            <h3>5. Informaci√≥n de Contacto</h3>
            
            <div class="field">
              <label for="nombre">Nombre de Contacto *</label>
              <input id="nombre" name="nombre" type="text" required />
            </div>

            <div class="field grid-2">
              <div>
                <label for="email">Email *</label>
                <input id="email" name="email" type="email" required />
              </div>
              <div>
                <label for="telefono">Tel√©fono</label>
                <input id="telefono" name="telefono" type="tel" />
              </div>
            </div>

            <div class="field">
              <label for="observaciones">Observaciones Adicionales</label>
              <textarea id="observaciones" name="observaciones" rows="3" placeholder="Especifica detalles particulares de tu evento..."></textarea>
            </div>
          </div>

          <div class="actions">
            <button type="submit" class="btn-primary">Generar Cotizaci√≥n</button>
            <button type="reset" class="btn-secondary">Limpiar Formulario</button>
          </div>
        </form>

        <!-- Mensaje de √âxito -->
        <div id="success-message" class="message success-message" hidden>
          <div class="message-header">
            <h3>‚úì ¬°Cotizaci√≥n Generada!</h3>
          </div>
          <div class="message-content">
            <p><strong>N√∫mero de Cotizaci√≥n:</strong> <span id="cotizacion-numero"></span></p>
            <p><strong>Valor Total:</strong> <span id="cotizacion-total"></span></p>
            <p><strong>Monto de Abono (50%):</strong> <span id="cotizacion-abono"></span></p>
          </div>
          <div class="message-actions">
            <button type="button" id="view-pdf-btn" class="btn-primary">Ver Cotizaci√≥n en PDF</button>
            <button type="button" id="download-pdf-btn" class="btn-secondary">Descargar PDF</button>
            <button type="button" id="nueva-cotizacion-btn" class="btn-tertiary">Hacer Otra Cotizaci√≥n</button>
          </div>
        </div>

        <!-- Mensaje de Error -->
        <div id="error-message" class="modal-error" hidden>
          <div class="modal-error__overlay"></div>
          <div class="modal-error__content">
            <button type="button" id="close-error-btn" class="modal-error__close" aria-label="Cerrar">‚úï</button>
            <div class="modal-error__icon">‚ö†</div>
            <h2 class="modal-error__title">Algo Sali√≥ Mal</h2>
            <p class="modal-error__message" id="error-text"></p>
            <div class="modal-error__actions">
              <button type="button" id="retry-btn" class="btn-primary">Intentar Nuevamente</button>
            </div>
          </div>
        </div>
      </main>
    </div>
  </section>

  <style>
    .cotizacion { 
      padding: 3rem 2rem; 
      max-width: 1400px; 
      margin: 0 auto; 
    }

    .cotizacion__header h1 { 
      font-size: clamp(2rem, 5vw, 3rem); 
      margin: 0 0 .5rem;
      color: #0f172a;
    }

    .cotizacion__header p {
      color: #64748b;
      font-size: 1.1rem;
      margin: 0;
    }

    .cotizacion__container { 
      display: grid; 
      grid-template-columns: 380px 1fr; 
      gap: 2.5rem; 
      align-items: start;
      margin-top: 2rem;
    }

    .cotizacion__media img { 
      width: 100%; 
      border-radius: 16px; 
      object-fit: cover; 
      height: 280px; 
      display: block;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.1);
    }

    .salon-info { 
      margin-top: 1.5rem; 
      color: #374151; 
    }

    .salon-info h2 { 
      margin: 0 0 .5rem; 
      font-size: 1.5rem;
      color: #0f172a;
      font-weight: 700;
    }

    .salon-info p { 
      margin: 0 0 1rem; 
      color: #64748b;
      line-height: 1.6;
    }

    .salon-info ul { 
      margin: 0; 
      padding-left: 0; 
      list-style: none;
      color: #374151; 
    }

    .salon-info li {
      padding: .5rem 0;
      font-size: .95rem;
      color: #475569;
    }

    .cotizacion__form {
      background: #fff;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(15, 23, 42, 0.08);
    }

    .form-section {
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .form-section:last-of-type {
      border-bottom: none;
    }

    .form-section h3 {
      margin: 0 0 1.25rem;
      font-size: 1.1rem;
      color: #0f172a;
      font-weight: 600;
    }

    .field { 
      margin-bottom: 1.25rem; 
    }

    .field small {
      display: block;
      margin-top: .4rem;
      color: #64748b;
      font-size: .85rem;
    }

    #horario-info {
      font-size: 0.9rem !important;
      font-weight: 500;
      border-radius: 6px;
      border-left-width: 4px !important;
      border-left-style: solid !important;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    label { 
      display: block; 
      font-weight: 600; 
      margin-bottom: .5rem; 
      color: #1e293b;
      font-size: .95rem;
    }

    input[type="text"], 
    input[type="email"], 
    input[type="tel"], 
    input[type="date"], 
    input[type="time"], 
    input[type="number"], 
    select, 
    textarea {
      width: 100%; 
      padding: .75rem; 
      border-radius: 8px; 
      border: 1.5px solid #e2e8f0; 
      background: #fff; 
      box-sizing: border-box;
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #0a4ba5;
      box-shadow: 0 0 0 3px rgba(10, 75, 165, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    .grid-2 { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 1rem; 
    }

    .checkboxes { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
      gap: 1rem;
      padding: .5rem 0;
    }

    .checkboxes label {
      display: flex;
      align-items: center;
      font-weight: 500;
      margin: 0;
      cursor: pointer;
    }

    .checkboxes input[type="checkbox"] {
      width: auto;
      margin-right: .5rem;
      cursor: pointer;
      accent-color: #0a4ba5;
    }

    .actions { 
      display: flex; 
      gap: 1rem; 
      margin-top: 2rem;
      flex-wrap: wrap;
    }

    .btn-primary,
    .btn-secondary,
    .btn-tertiary { 
      padding: .8rem 1.5rem; 
      border-radius: 8px; 
      border: none; 
      cursor: pointer; 
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.2s ease;
    }

    .btn-primary { 
      background: #0a4ba5; 
      color: #fff;
      flex: 1;
      min-width: 200px;
    }

    .btn-primary:hover {
      background: #083a82;
      box-shadow: 0 4px 12px rgba(10, 75, 165, 0.3);
    }

    .btn-secondary { 
      background: transparent; 
      border: 1.5px solid #cbd5e1; 
      color: #0f172a;
    }

    .btn-secondary:hover {
      border-color: #0a4ba5;
      color: #0a4ba5;
      background: #f0f6ff;
    }

    .btn-tertiary {
      background: #f1f5f9;
      color: #0f172a;
      border: 1.5px solid #e2e8f0;
    }

    .btn-tertiary:hover {
      background: #e2e8f0;
    }

    .message {
      margin-top: 1.5rem;
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid;
    }

    .message-header h3 {
      margin: 0;
      font-size: 1.1rem;
    }

    .message-content {
      margin: 1rem 0;
    }

    .message-content p {
      margin: .5rem 0;
      font-size: .95rem;
    }

    .message-actions {
      display: flex;
      gap: .75rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }

    .success-message {
      background: #ecfdf5;
      border-color: #86efac;
    }

    .success-message .message-header h3 {
      color: #065f46;
    }

    .success-message .message-content {
      color: #047857;
    }

    /* MODAL DE ERROR - PANTALLA COMPLETA */
    .modal-error {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-error__overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
    }

    .modal-error__content {
      position: relative;
      background: white;
      border-radius: 16px;
      padding: 2.5rem 2.5rem;
      max-width: 480px;
      width: 90%;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.35);
      animation: slideIn 0.3s ease-out;
      text-align: center;
      border: 2px solid #fecaca;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-error__close {
      position: absolute;
      top: 1.2rem;
      right: 1.2rem;
      background: #fee2e2;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #991b1b;
      padding: 0.5rem 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s;
      width: 36px;
      height: 36px;
    }

    .modal-error__close:hover {
      background: #fca5a5;
      color: #7f1d1d;
      transform: scale(1.1);
    }

    .modal-error__icon {
      font-size: 3.5rem;
      margin-bottom: 1rem;
      display: inline-block;
      animation: pulse 0.5s ease-out;
    }

    @keyframes pulse {
      0% {
        transform: scale(0.8);
        opacity: 0;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .modal-error__title {
      font-size: 1.6rem;
      font-weight: 800;
      color: #991b1b;
      margin: 0 0 0.75rem;
      letter-spacing: -0.5px;
    }

    .modal-error__message {
      font-size: 0.95rem;
      color: #7f1d1d;
      margin: 0 0 2rem;
      line-height: 1.6;
      word-wrap: break-word;
    }

    .modal-error__actions {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .modal-error__actions .btn-primary {
      background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
      color: white;
      padding: 0.85rem 2.2rem;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      font-size: 0.95rem;
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }

    .modal-error__actions .btn-primary:hover {
      background: linear-gradient(135deg, #b91c1c 0%, #7f1d1d 100%);
      box-shadow: 0 8px 20px rgba(220, 38, 38, 0.4);
      transform: translateY(-2px);
    }

    .modal-error__actions .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
    }

    .error-message {
      background: #fef2f2;
      border-color: #fca5a5;
    }

    .error-message .message-header h3 {
      color: #991b1b;
    }

    .error-message .message-content {
      color: #dc2626;
    }

    [hidden] {
      display: none !important;
    }

    @media (max-width: 1024px) { 
      .cotizacion__container { 
        grid-template-columns: 1fr; 
      }
      .cotizacion__media {
        max-width: 500px;
        margin: 0 auto;
      }
    }

    @media (max-width: 640px) {
      .cotizacion {
        padding: 1.5rem 1rem;
      }
      .cotizacion__form {
        padding: 1.5rem;
      }
      .grid-2 {
        grid-template-columns: 1fr;
      }
      .actions {
        flex-direction: column;
      }
      .btn-primary,
      .btn-secondary {
        width: 100%;
      }
    }
  </style>

  <script type="module">
    const API_URL = 'http://localhost:3333'
    
    let currentCotizacionId = null

    // Elementos del DOM
    const salonSelect = document.getElementById('salon')
    const disposicionSelect = document.getElementById('disposicion')
    const form = document.getElementById('cotizacion-form')
    const successMessage = document.getElementById('success-message')
    const errorMessage = document.getElementById('error-message')
    const img = document.getElementById('salon-image')
    const title = document.getElementById('salon-title')
    const desc = document.getElementById('salon-description')
    const capacidadInfo = document.getElementById('capacidad-info')
    const precio4hInfo = document.getElementById('precio-4h-info')
    const precio8hInfo = document.getElementById('precio-8h-info')
    const asistentesInput = document.getElementById('asistentes')
    const capacidadInfoText = document.getElementById('capacidad-info-text')

    const descriptions = {
      'MI LLANURA': 'Sal√≥n insignia con vista a las √°reas verdes, ambientaci√≥n adaptable. Ideal para recepciones, matrimonios y eventos corporativos.',
      'BAR': 'Ambiente contempor√°neo con barra integrada, iluminaci√≥n esc√©nica y sistema de sonido premium. Recomendado para cocteles y lanzamientos.',
      'EMPRESARIAL': 'Equipado con pantallas, streaming, mobiliario modular y conectividad para eventos corporativos, conferencias y workshops.',
      'TERRAZA': 'Espacio al aire libre con p√©rgolas y vistas; ideal para eventos sunset, bodas y recepciones.',
      'KIOSKO': '√Årea semiabierta rodeada de jardines, perfecta para reuniones familiares y celebraciones.',
      'PRESIDENTE': 'Espacio exclusivo con mobiliario ejecutivo, insonorizaci√≥n y servicio gourmet para reuniones privadas.'
    }

    // CONFIGURACI√ìN DE VALIDACI√ìN DE FECHAS (modifica estos valores seg√∫n necesites)
    const DIAS_MAXIMO_FUTURO = 30  // M√°ximo 30 d√≠as (1 mes) en el futuro
    const PERMITIR_HOY = true       // true = permitir reservas para hoy, false = solo futuras

    // Configurar restricciones de fecha en el input
    function configurarRestriccionesFecha() {
      const dateInput = document.getElementById('date')
      const hoy = new Date()
      
      // Obtener fecha local en formato YYYY-MM-DD sin conversi√≥n a UTC
      const year = hoy.getFullYear()
      const month = String(hoy.getMonth() + 1).padStart(2, '0')
      const day = String(hoy.getDate()).padStart(2, '0')
      const fechaHoyLocal = `${year}-${month}-${day}`
      
      // Fecha m√≠nima (hoy o ma√±ana)
      let minDate = fechaHoyLocal
      if (!PERMITIR_HOY) {
        const manana = new Date(hoy)
        manana.setDate(manana.getDate() + 1)
        const yearM = manana.getFullYear()
        const monthM = String(manana.getMonth() + 1).padStart(2, '0')
        const dayM = String(manana.getDate()).padStart(2, '0')
        minDate = `${yearM}-${monthM}-${dayM}`
      }
      
      // Fecha m√°xima (hoy + DIAS_MAXIMO_FUTURO)
      const fechaMax = new Date(hoy)
      fechaMax.setDate(fechaMax.getDate() + DIAS_MAXIMO_FUTURO)
      const yearMax = fechaMax.getFullYear()
      const monthMax = String(fechaMax.getMonth() + 1).padStart(2, '0')
      const dayMax = String(fechaMax.getDate()).padStart(2, '0')
      const maxDate = `${yearMax}-${monthMax}-${dayMax}`
      
      dateInput.setAttribute('min', minDate)
      dateInput.setAttribute('max', maxDate)
      
      console.log(`üìÖ Restricciones de fecha: min=${minDate}, max=${maxDate}`)
    }

    // Aplicar restricciones al cargar
    configurarRestriccionesFecha()

    // Horarios de operaci√≥n (formato 24 horas)
    const horarios = {
      0: { nombre: 'Domingo', activo: false, inicio: '‚Äî', fin: '‚Äî' },
      1: { nombre: 'Lunes', activo: false, inicio: '‚Äî', fin: '‚Äî' },
      2: { nombre: 'Martes', activo: true, inicio: '08:00', fin: '22:00' },
      3: { nombre: 'Mi√©rcoles', activo: true, inicio: '08:00', fin: '22:00' },
      4: { nombre: 'Jueves', activo: true, inicio: '08:00', fin: '22:00' },
      5: { nombre: 'Viernes', activo: true, inicio: '08:00', fin: '02:00' }, // 02:00 = 2 AM (ma√±ana siguiente)
      6: { nombre: 'S√°bado', activo: true, inicio: '08:00', fin: '02:00' }  // 02:00 = 2 AM (ma√±ana siguiente)
    }

    // CARGAR DISPOSICIONES DEL ESPACIO
    async function cargarDisposicionesDelEspacio(espacioId) {
      try {
        console.log('Cargando disposiciones para espacio:', espacioId)
        disposicionSelect.innerHTML = '<option value="">Cargando...</option>'
        
        const response = await fetch(`${API_URL}/api/espacios/${espacioId}/configuraciones`)
        const result = await response.json()
        
        console.log('Respuesta configuraciones:', result)
        
        if (result.success && result.data && result.data.length > 0) {
          let html = ''
          result.data.forEach(config => {
            try {
              const disposicionNombre = config.disposicion?.nombre || 'Sin nombre'
              const capacidad = config.capacidad || 0
              html += `<option value="${config.id}" data-capacidad="${capacidad}">
                ${disposicionNombre} (Capacidad: ${capacidad})
              </option>`
            } catch (e) {
              console.error('Error procesando config:', config, e)
            }
          })
          
          if (html) {
            disposicionSelect.innerHTML = html
            console.log('Disposiciones cargadas:', result.data.length)
            actualizarCapacidad()
          } else {
            disposicionSelect.innerHTML = '<option value="">Sin opciones v√°lidas</option>'
          }
        } else {
          console.warn('Sin datos:', result)
          disposicionSelect.innerHTML = '<option value="">No hay disposiciones</option>'
        }
      } catch (error) {
        console.error('Error:', error)
        disposicionSelect.innerHTML = '<option value="">Error</option>'
      }
    }

    // ACTUALIZAR CAPACIDAD CUANDO CAMBIA DISPOSICI√ìN
    function actualizarCapacidad() {
      const selected = disposicionSelect.selectedOptions[0]
      if (!selected) return
      
      const capacidad = parseInt(selected.dataset.capacidad)
      capacidadInfoText.textContent = `(M√°x: ${capacidad})`
      asistentesInput.max = capacidad
      
      if (parseInt(asistentesInput.value) > capacidad) {
        asistentesInput.value = capacidad
      }
    }

    // CARGAR SERVICIOS
    async function cargarServicios() {
      try {
        const response = await fetch(`${API_URL}/api/prestaciones`)
        const result = await response.json()
        
        if (result.success && result.data) {
          const container = document.getElementById('servicios-checkboxes')
          let html = ''
          result.data.forEach(s => {
            html += `<label>
              <input type="checkbox" name="servicios" value="${s.id}" />
              ${s.nombre}
            </label>`
          })
          container.innerHTML = html
        }
      } catch (error) {
        console.error('Error cargando servicios:', error)
      }
    }

    // CARGAR TARIFAS DEL SAL√ìN
    async function cargarTarifas(espacioId) {
      try {
        precio4hInfo.textContent = '4 horas: Cargando...'
        precio8hInfo.textContent = '8 horas: Cargando...'
        
        const response = await fetch(`${API_URL}/api/espacios/${espacioId}/tarifas`)
        const data = await response.json()
        
        if (data.success) {
          const precio4h = data.data.precio4Horas 
            ? `$${data.data.precio4Horas.toLocaleString('es-CO')}` 
            : 'Consultar'
          const precio8h = data.data.precio8Horas 
            ? `$${data.data.precio8Horas.toLocaleString('es-CO')}` 
            : 'Consultar'
          
          precio4hInfo.textContent = `4 horas: ${precio4h}`
          precio8hInfo.textContent = `8 horas: ${precio8h}`
        }
      } catch (error) {
        console.error('Error cargando tarifas:', error)
      }
    }

    // CARGAR HORAS DISPONIBLES
    async function cargarHorasDisponibles(espacioId, fecha, duracion = 4) {
      const timeSelect = document.getElementById('time')
      const horasInfo = document.getElementById('horas-info')
      
      try {
        console.log(`Cargando horas para espacioId=${espacioId}, fecha=${fecha}, duracion=${duracion}`)
        timeSelect.innerHTML = '<option value="">Cargando horas...</option>'
        timeSelect.disabled = true
        horasInfo.style.display = 'none'
        
        const response = await fetch(`${API_URL}/api/disponibilidad/horas?espacioId=${espacioId}&fecha=${fecha}&duracion=${duracion}`)
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`)
        }
        
        const result = await response.json()
        console.log('Respuesta horas disponibles:', result)
        
        if (result.success && result.data) {
          const horas = result.data.horasDisponibles
          
          if (horas.length === 0) {
            timeSelect.innerHTML = '<option value="">No hay horas disponibles</option>'
            horasInfo.textContent = result.data.mensaje || 'No hay horarios disponibles para esta fecha'
            horasInfo.style.display = 'block'
            horasInfo.style.color = '#dc2626'
            console.log('‚ö†Ô∏è Sin horas disponibles')
            return
          }
          
          let html = '<option value="">Selecciona una hora</option>'
          horas.forEach(hora => {
            html += `<option value="${hora}">${hora}</option>`
          })
          timeSelect.innerHTML = html
          timeSelect.disabled = false
          
          horasInfo.textContent = `‚úì ${horas.length} horarios disponibles`
          horasInfo.style.display = 'block'
          horasInfo.style.color = '#10b981'
          console.log(`‚úÖ ${horas.length} horas disponibles cargadas`)
        } else {
          throw new Error(result.message || 'Respuesta inv√°lida del servidor')
        }
      } catch (error) {
        console.error('‚ùå Error cargando horas:', error)
        timeSelect.innerHTML = '<option value="">Error al cargar (revisa servidor)</option>'
        horasInfo.textContent = 'Error: Verifica que el servidor backend est√© corriendo'
        horasInfo.style.display = 'block'
        horasInfo.style.color = '#dc2626'
      }
    }

    // EVENT: CAMBIO DE SAL√ìN
    salonSelect.addEventListener('change', async (e) => {
      try {
        const salonData = JSON.parse(e.target.value)
        const opt = e.target.selectedOptions[0]
        const imgSrc = opt.dataset.img
        const capacidad = opt.dataset.capacidad
        
        img.src = imgSrc
        title.textContent = salonData.nombre
        desc.textContent = descriptions[salonData.nombre] || ''
        capacidadInfo.textContent = `Capacidad: hasta ${capacidad} personas`
        
        // Cargar disposiciones del nuevo sal√≥n
        cargarDisposicionesDelEspacio(salonData.id)
        
        // Cargar tarifas del nuevo sal√≥n
        cargarTarifas(salonData.id)
        
        // Cargar horas disponibles si ya hay fecha seleccionada
        const dateInput = document.getElementById('date')
        if (dateInput.value) {
          const durationInput = document.getElementById('duration')
          const duracion = durationInput.value ? parseInt(durationInput.value) : 4
          await cargarHorasDisponibles(salonData.id, dateInput.value, duracion)
        }
      } catch (error) {
        console.error('Error al cambiar sal√≥n:', error)
      }
    })

    // EVENT: CAMBIO DE DISPOSICI√ìN
    disposicionSelect.addEventListener('change', actualizarCapacidad)

    // EVENT: CAMBIO DE FECHA - MOSTRAR HORARIO Y CARGAR HORAS
    const dateInput = document.getElementById('date')
    const horarioInfo = document.getElementById('horario-info')
    
    dateInput.addEventListener('change', async () => {
      if (!dateInput.value) {
        horarioInfo.style.display = 'none'
        document.getElementById('time').innerHTML = '<option value="">Selecciona primero la fecha</option>'
        document.getElementById('time').disabled = true
        return
      }
      
      const date = new Date(dateInput.value + 'T00:00:00')
      const diaSemana = date.getDay()
      const horario = horarios[diaSemana]
      
      if (horario) {
        if (horario.activo) {
          // Formato 24 horas expl√≠cito
          const horaInicioTexto = horario.inicio
          const horaFinTexto = horario.fin === '02:00' ? '02:00 ma√±ana siguiente' : horario.fin
          horarioInfo.innerHTML = `<strong>üìÖ ${horario.nombre}</strong> - Horario: ${horaInicioTexto} a ${horaFinTexto}`
          horarioInfo.style.background = '#ecfdf5'
          horarioInfo.style.borderLeftColor = '#10b981'
          horarioInfo.style.color = '#065f46'
        } else {
          horarioInfo.innerHTML = `<strong>‚õî ${horario.nombre}</strong> - El club est√° cerrado este d√≠a`
          horarioInfo.style.background = '#fef2f2'
          horarioInfo.style.borderLeftColor = '#dc2626'
          horarioInfo.style.color = '#991b1b'
          document.getElementById('time').innerHTML = '<option value="">Club cerrado este d√≠a</option>'
          document.getElementById('time').disabled = true
          document.getElementById('horas-info').style.display = 'none'
          horarioInfo.style.display = 'block'
          return
        }
        horarioInfo.style.display = 'block'
      }
      
      // Cargar horas disponibles si hay sal√≥n seleccionado
      const salonSelect = document.getElementById('salon')
      if (salonSelect.value) {
        const salonData = JSON.parse(salonSelect.value)
        const durationInput = document.getElementById('duration')
        const duracion = durationInput.value ? parseInt(durationInput.value) : 4
        await cargarHorasDisponibles(salonData.id, dateInput.value, duracion)
      } else {
        document.getElementById('time').innerHTML = '<option value="">Selecciona primero el sal√≥n</option>'
        document.getElementById('time').disabled = true
      }
    })

    // CALCULAR Y MOSTRAR HORA FINAL
    function calcularHoraFinal() {
      const timeSelect = document.getElementById('time')
      const durationInput = document.getElementById('duration')
      const horaFinalInput = document.getElementById('hora-final')
      const duracionInfo = document.getElementById('duracion-info')
      
      // Limpiar si no hay hora de inicio
      if (!timeSelect.value || timeSelect.value === '' || !durationInput.value) {
        horaFinalInput.value = 'Selecciona hora de inicio'
        duracionInfo.style.display = 'none'
        return
      }
      
      const horaInicio = timeSelect.value // formato "HH:mm"
      const duracion = parseInt(durationInput.value)
      
      // Parsear hora de inicio
      const [horas, minutos] = horaInicio.split(':').map(Number)
      
      // Calcular hora final
      let horaFinal = horas + duracion
      const minutosFinal = minutos
      
      // Ajustar si pasa de 24 horas
      if (horaFinal >= 24) {
        horaFinal = horaFinal - 24
      }
      
      // Formatear hora final
      const horaFinalStr = `${String(horaFinal).padStart(2, '0')}:${String(minutosFinal).padStart(2, '0')}`
      
      horaFinalInput.value = horaFinalStr
      duracionInfo.style.display = 'none'
      
      console.log(`üìÖ Hora calculada: ${horaInicio} + ${duracion}h = ${horaFinalStr}`)
    }

    // EVENT: CAMBIO DE DURACI√ìN - RECARGAR HORAS DISPONIBLES Y RECALCULAR HORA FINAL
    const durationInput = document.getElementById('duration')
    durationInput.addEventListener('change', async () => {
      const salonSelect = document.getElementById('salon')
      const dateInput = document.getElementById('date')
      const timeSelect = document.getElementById('time')
      
      // Validar m√≠nimo 4 horas
      const duracionValue = parseInt(durationInput.value)
      if (duracionValue < 4) {
        alert('La duraci√≥n m√≠nima es de 4 horas')
        durationInput.value = 4
        return
      }
      
      // Validar m√°ximo 8 horas para clientes
      if (duracionValue > 8) {
        alert('La duraci√≥n m√°xima para clientes es de 8 horas. Horas adicionales se cobran por separado.')
        durationInput.value = 8
        return
      }
      
      // Guardar la hora de inicio seleccionada antes de recargar
      const horaInicioPrevia = timeSelect.value
      
      // Recalcular hora final con la nueva duraci√≥n
      calcularHoraFinal()
      
      // Solo recargar si ya hay sal√≥n y fecha seleccionados
      if (salonSelect.value && dateInput.value) {
        const salonData = JSON.parse(salonSelect.value)
        const duracion = durationInput.value ? parseInt(durationInput.value) : 4
        await cargarHorasDisponibles(salonData.id, dateInput.value, duracion)
        
        // Restaurar la hora de inicio si sigue siendo v√°lida en las nuevas opciones
        if (horaInicioPrevia) {
          // Verificar si la hora previa existe en las nuevas opciones
          const options = Array.from(timeSelect.options).map(opt => opt.value)
          if (options.includes(horaInicioPrevia)) {
            timeSelect.value = horaInicioPrevia
            calcularHoraFinal() // Recalcular con la hora restaurada
          }
        }
      }
    })

    // EVENT: CAMBIO DE HORA DE INICIO - CALCULAR HORA FINAL
    const timeSelect = document.getElementById('time')
    timeSelect.addEventListener('change', () => {
      calcularHoraFinal()
    })

    // EVENT: VALIDAR ASISTENTES
    asistentesInput.addEventListener('change', () => {
      const selected = disposicionSelect.selectedOptions[0]
      if (!selected) return
      
      const capacidad = parseInt(selected.dataset.capacidad)
      const asistentes = parseInt(asistentesInput.value)
      
      if (asistentes > capacidad) {
        alert(`M√°ximo ${capacidad} personas para esta disposici√≥n`)
        asistentesInput.value = capacidad
      }
    })

    // ENVIAR FORMULARIO
    form.addEventListener('submit', async (e) => {
      e.preventDefault()

      // VALIDAR
      if (!disposicionSelect.value) {
        alert('Selecciona una disposici√≥n')
        return
      }

      const selected = disposicionSelect.selectedOptions[0]
      const capacidad = parseInt(selected.dataset.capacidad)
      const asistentes = parseInt(asistentesInput.value)
      
      if (asistentes > capacidad) {
        alert(`M√°ximo ${capacidad} personas`)
        return
      }

      const salonData = JSON.parse(salonSelect.value)
      const servicios = Array.from(form.querySelectorAll('input[name="servicios"]:checked')).map(i => parseInt(i.value))

      const cotizacionData = {
        espacioId: salonData.id,
        configuracionEspacioId: parseInt(disposicionSelect.value),
        fecha: document.getElementById('date').value,
        horaInicio: document.getElementById('time').value,
        duracion: parseInt(document.getElementById('duration').value),
        tipoEvento: document.getElementById('tipoEvento').value,
        asistentes: asistentes,
        tipoCliente: 'particular',
        servicios,
        nombre: document.getElementById('nombre').value,
        email: document.getElementById('email').value,
        telefono: document.getElementById('telefono').value || undefined,
        observaciones: document.getElementById('observaciones').value || undefined,
      }

      successMessage.hidden = true
      errorMessage.hidden = true

      const submitBtn = form.querySelector('button[type="submit"]')
      const originalText = submitBtn.textContent
      submitBtn.disabled = true
      submitBtn.textContent = 'Generando...'

      try {
        const response = await fetch(`${API_URL}/api/cotizaciones`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(cotizacionData),
        })

        const result = await response.json()

        if (result.success && result.data) {
          // Verificar si hay disponibilidad
          if (!result.data.disponible) {
            document.getElementById('error-text').textContent = `No hay disponibilidad: ${result.data.mensajeDisponibilidad || 'Fecha/hora no disponible'}`
            errorMessage.hidden = false
            return
          }
          
          currentCotizacionId = result.data.cotizacion.id
          document.getElementById('cotizacion-numero').textContent = `#${result.data.cotizacion.cotizacionNumero}`
          document.getElementById('cotizacion-total').textContent = `$${result.data.cotizacion.valorTotal.toLocaleString('es-CO')}`
          document.getElementById('cotizacion-abono').textContent = `$${result.data.montoAbono.toLocaleString('es-CO')}`
          
          successMessage.hidden = false
          form.style.display = 'none'
        } else {
          document.getElementById('error-text').textContent = result.message || 'Error'
          errorMessage.hidden = false
        }
      } catch (error) {
        document.getElementById('error-text').textContent = 'Error de conexi√≥n'
        errorMessage.hidden = false
      } finally {
        submitBtn.disabled = false
        submitBtn.textContent = originalText
      }
    })

    // BOTONES DE ACCI√ìN
    document.getElementById('view-pdf-btn')?.addEventListener('click', () => {
      if (currentCotizacionId) {
        window.open(`${API_URL}/api/cotizaciones/${currentCotizacionId}/pdf`, '_blank')
      }
    })

    document.getElementById('download-pdf-btn')?.addEventListener('click', () => {
      if (currentCotizacionId) {
        window.open(`${API_URL}/api/cotizaciones/${currentCotizacionId}/pdf`, '_blank')
      }
    })

    document.getElementById('nueva-cotizacion-btn')?.addEventListener('click', () => {
      form.style.display = 'block'
      form.reset()
      successMessage.hidden = true
      currentCotizacionId = null
      cargarDisposicionesDelEspacio(1) // Reset a MI LLANURA
      window.scrollTo({ top: 0, behavior: 'smooth' })
    })

    // BOTONES DE ERROR MODAL
    document.getElementById('close-error-btn')?.addEventListener('click', () => {
      errorMessage.hidden = true
    })

    document.getElementById('retry-btn')?.addEventListener('click', () => {
      errorMessage.hidden = true
    })

    // Cerrar modal al hacer clic en el overlay
    const errorModal = document.getElementById('error-message')
    if (errorModal) {
      errorModal.addEventListener('click', (e) => {
        if (e.target === errorModal || e.target.classList.contains('modal-error__overlay')) {
          errorModal.hidden = true
        }
      })
    }

    // INICIALIZAR
    console.log('Iniciando...')
    cargarServicios()
    cargarTarifas(1)
    cargarDisposicionesDelEspacio(1)
  </script>

</BaseLayout>
